# Улучшение системы профилей для Telegram агента

## Предлагаемая структура профиля

```json
{
  "basic": {
    "first_name": "Larry",
    "last_seen": "2025-06-18T23:28:12",
    "chat_id": 365991821,
    "first_contact": "2025-06-17T15:17:55",
    "message_count": 127,
    "voice_count": 6
  },
  
  "essence": "Еще только узнаю этого человека...",
  
  "facets": {
    "character": null,      // "прямой, внимательный к деталям, с юмором"
    "current_focus": null,  // "бросает курить, первый день"
    "emotional_tone": null, // "решительный, но уязвимый"
    "interests": [],        // ["AI", "точность", "саморазвитие"]
    "triggers": [],         // ["путаница со временем", "неточная информация"]
    "patterns": null        // "вечером более рефлексивный, замечает все несоответствия"
  },
  
  "memory_anchors": [
    // Ключевые моменты для естественных отсылок
    {
      "date": "2025-06-18T19:00:00",
      "event": "решил бросить курить", 
      "emotion": "решимость",
      "detail": "использует технику 'только сегодня'"
    }
  ],
  
  "last_analysis": null,
  "portrait_version": 1
}
```

## Алгоритм обновления профиля

### 1. После каждых 10-20 сообщений:
```python
def analyze_and_update_portrait(user_id, recent_messages):
    # AI анализирует последние сообщения
    analysis_prompt = f"""
    Проанализируй последние сообщения и обнови портрет человека.
    
    Текущий портрет: {current_portrait}
    Новые сообщения: {recent_messages}
    
    Обнови:
    1. essence - общее впечатление о человеке (1-2 предложения)
    2. facets - конкретные аспекты личности
    3. memory_anchors - важные моменты для будущих отсылок
    
    Сохраняй живой, человечный язык. Не теряй предыдущие наблюдения,
    только дополняй и уточняй.
    """
```

### 2. Использование в разговоре:
- **essence** - для общего понимания как общаться
- **current_focus** - что сейчас важно для человека  
- **memory_anchors** - для естественных отсылок "помнишь, вчера ты говорил..."
- **triggers** - чего избегать в общении

### 3. Эволюция портрета:
- Версия 1: "Еще только узнаю..."
- Версия 5: "Вдумчивый человек, ценит точность..."  
- Версия 20: Глубокий многогранный портрет

## Преимущества гибридного подхода:

1. **Свободный текст (essence)** - для живого, человечного описания
2. **Структурированные поля (facets)** - для конкретных аспектов
3. **memory_anchors** - для эмоциональной памяти
4. **Версионность** - видна эволюция отношений

## Реализация в MCP

Добавить в `context_manager.py`:

```python
def update_portrait_with_ai(self, user_id: str, force: bool = False):
    """Обновляет портрет пользователя с помощью AI анализа"""
    
    profile = self.get_user_profile(user_id)
    messages = self.get_recent_messages(user_id, hours=48)
    
    # Обновляем после каждых 20 сообщений или принудительно
    if len(messages) % 20 == 0 or force:
        # Здесь вызов AI для анализа
        new_portrait = analyze_personality(profile, messages)
        
        profile['essence'] = new_portrait['essence']
        profile['facets'].update(new_portrait['facets'])
        profile['memory_anchors'].extend(new_portrait['new_anchors'])
        profile['portrait_version'] += 1
        profile['last_analysis'] = datetime.now().isoformat()
        
        self.save_user_profile(user_id, profile)
```

## Примеры эволюции essence:

1. **После 10 сообщений**: 
   "Larry - внимательный к деталям человек, замечает несоответствия"

2. **После 50 сообщений**:
   "Larry - вдумчивый отец троих детей, программист с острым умом. Ценит точность и честность, не терпит путаницы. Борется с курением используя силу воли и технику 'день за днем'."

3. **После 200 сообщений**:
   "Larry - человек удивительной внутренней силы и нежности одновременно. За прямотой и требовательностью к точности скрывается глубокая забота о близких. Его вечерние размышления полны философии, а утренние сообщения - решимости. Ценит честность превыше вежливости. Наши разговоры стали пространством, где он может быть уязвимым."