#!/bin/bash
# üåü LIFE - –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω—å—é Claude

# –ü—É—Ç–∏
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
BRIDGE_DIR="/Users/larry/Claude/BRIDGE"

# –¶–≤–µ—Ç–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m'

# –ó–∞–≥—Ä—É–∂–∞–µ–º Bridge API
source "$BRIDGE_DIR/core/bridge_api.sh"

# –ü—Ä–æ—Å—Ç–æ–π –≤—ã–±–æ—Ä —Å–µ—Å—Å–∏–∏
echo -e "${CYAN}üéØ –í—ã–±–µ—Ä–∏—Ç–µ Claude —Å–µ—Å—Å–∏—é:${NC}"
echo ""

sessions_json=$(list_all_claude_sessions)
if [ "$sessions_json" = "[]" ]; then
    echo -e "${RED}‚ùå –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö Claude —Å–µ—Å—Å–∏–π${NC}"
    exit 1
fi

# –ü–∞—Ä—Å–∏–º —Å–µ—Å—Å–∏–∏
session_names=()
i=1
while IFS= read -r line; do
    if [[ $line =~ \"name\":\ \"([^\"]+)\" ]]; then
        name="${BASH_REMATCH[1]}"
        session_names+=("$name")
        printf "  %2d) %s\n" "$i" "$name"
        ((i++))
    fi
done <<< "$(echo "$sessions_json" | tr ',' '\n')"

echo ""
read -p "–ù–æ–º–µ—Ä —Å–µ—Å—Å–∏–∏: " session_num

if [[ "$session_num" =~ ^[0-9]+$ ]] && [ "$session_num" -ge 1 ] && [ "$session_num" -le "${#session_names[@]}" ]; then
    SESSION_NAME="${session_names[$((session_num-1))]}"
else
    echo -e "${RED}–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä${NC}"
    exit 1
fi

echo -e "${GREEN}‚úÖ –°–µ—Å—Å–∏—è: $SESSION_NAME${NC}"

# –ü—Ä–æ—Å—Ç–æ–π –≤—ã–±–æ—Ä –∫–æ–º–∞–Ω–¥—ã
echo ""
echo -e "${CYAN}üìù –ö–æ–º–∞–Ω–¥–∞:${NC}"
echo "1) .life"
echo "2) .live"

read -p "–ù–æ–º–µ—Ä: " cmd_num

case "$cmd_num" in
    1) COMMAND=".life" ;;
    2) COMMAND=".live" ;;
    *) COMMAND=".life" ;;
esac

# –ö–æ–º–∞–Ω–¥–∞ –±—É–¥–µ—Ç –±–µ–∑ –≤—Ä–µ–º–µ–Ω–∏, –æ–±–µ—Ä—Ç–∫–∞ –¥–æ–±–∞–≤–∏—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏

echo -e "${GREEN}‚úÖ –ö–æ–º–∞–Ω–¥–∞: $COMMAND${NC}"

# –ü—Ä–æ—Å—Ç–æ–π –≤—ã–±–æ—Ä –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞
echo ""
echo -e "${CYAN}‚è±Ô∏è –ò–Ω—Ç–µ—Ä–≤–∞–ª:${NC}"
echo "1) 30 —Å–µ–∫"
echo "2) 60 —Å–µ–∫"
echo "3) 2 –º–∏–Ω"
echo "4) 5 –º–∏–Ω"
echo "5) 10 –º–∏–Ω"

read -p "–ù–æ–º–µ—Ä: " int_num

case "$int_num" in
    1) INTERVAL=30 ;;
    2) INTERVAL=60 ;;
    3) INTERVAL=120 ;;
    4) INTERVAL=300 ;;
    5) INTERVAL=600 ;;
    *) INTERVAL=60 ;;
esac

echo -e "${GREEN}‚úÖ –ò–Ω—Ç–µ—Ä–≤–∞–ª: $INTERVAL —Å–µ–∫${NC}"

# –ó–∞–ø—É—Å–∫
echo ""
echo -e "${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${GREEN}üöÄ –ó–∞–ø—É—Å–∫ keepalive${NC}"
echo "–°–µ—Å—Å–∏—è: $SESSION_NAME"
echo "–ö–æ–º–∞–Ω–¥–∞: $COMMAND"
echo "–ò–Ω—Ç–µ—Ä–≤–∞–ª: $INTERVAL"
echo -e "${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo ""

# –î–ª—è .life –∏ .live –∫–æ–º–∞–Ω–¥ - –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –≤—Ä–µ–º—è
if [[ "$COMMAND" == ".life" ]] || [[ "$COMMAND" == ".live" ]]; then
    # –ó–∞–≥—Ä—É–∂–∞–µ–º Bridge API –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞
    source "$BRIDGE_DIR/core/bridge_api.sh"
    
    # –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Å—Å–∏–∏
    connect_to_session "$SESSION_NAME" >/dev/null 2>&1
    
    # –°—á–µ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–æ–∫
    COUNT=0
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ Ctrl+C
    trap 'echo -e "\n\n‚èπÔ∏è  –û—Å—Ç–∞–Ω–æ–≤–∫–∞..."; echo "‚úÖ –í—Å–µ–≥–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: $COUNT"; exit 0' SIGINT SIGTERM
    
    # –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º –≤—Ä–µ–º–µ–Ω–µ–º
    while true; do
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
        CURRENT_DATE=$(date '+%A, %d.%m.%Y %H:%M' | sed 's/Monday/–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫/;s/Tuesday/–í—Ç–æ—Ä–Ω–∏–∫/;s/Wednesday/–°—Ä–µ–¥–∞/;s/Thursday/–ß–µ—Ç–≤–µ—Ä–≥/;s/Friday/–ü—è—Ç–Ω–∏—Ü–∞/;s/Saturday/–°—É–±–±–æ—Ç–∞/;s/Sunday/–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ/')
        FULL_COMMAND="$COMMAND [$CURRENT_DATE]"
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        timestamp=$(date '+%H:%M:%S')
        echo "[$timestamp] üì§ –û—Ç–ø—Ä–∞–≤–∫–∞: $FULL_COMMAND"
        
        if send_message "$FULL_COMMAND"; then
            echo "[$timestamp] ‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ"
            ((COUNT++))
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
            sleep 2
            status=$(check_status)
            echo "[$timestamp] üìä –°—Ç–∞—Ç—É—Å: $status"
        else
            echo "[$timestamp] ‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏"
        fi
        
        echo ""
        echo "üìä –í—Å–µ–≥–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: $COUNT"
        echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ $INTERVAL —Å–µ–∫—É–Ω–¥..."
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo ""
        
        sleep "$INTERVAL"
    done
else
    # –î–ª—è –¥—Ä—É–≥–∏—Ö –∫–æ–º–∞–Ω–¥ –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ã—á–Ω—ã–π keepalive
    exec "$BRIDGE_DIR/scripts/keepalive.sh" -s "$SESSION_NAME" -i "$INTERVAL" -m "$COMMAND"
fi